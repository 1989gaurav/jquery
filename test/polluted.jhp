<?
var baseURL = "http://ajax.googleapis.com/ajax/libs/",
	libraries = {
		"Dojo": {
			"versions": [ "1.1.1", "1.2.0", "1.2.3", "1.3.0", "1.3.1", "1.3.2", "1.4.0", "1.4.1", "1.4.3", "1.5.0" ],
			"url": "dojo/XYZ/dojo/dojo.xd.js"
		},
		"ExtCore": {
			"versions": [ "3.0.0", "3.1.0" ],
			"url": "ext-core/XYZ/ext-core.js"
		},
		"jQuery": {
			"versions": [ "1.2.3", "1.2.6", "1.3.0", "1.3.1", "1.3.2", "1.4.0", "1.4.1", "1.4.2", "1.4.3", "1.4.4", "1.5.0" ],
			"url": "jquery/XYZ/jquery.min.js"
		},
		"jQueryUI": {
			"versions": [ "1.5.2", "1.5.3", "1.6.0", "1.7.0", "1.7.1", "1.7.2", "1.7.3", "1.8.0", "1.8.1", "1.8.2", "1.8.4", "1.8.5", "1.8.6", "1.8.7", "1.8.8", "1.8.9" ],
			"url": "jqueryui/XYZ/jquery-ui.min.js"
		},
		"MooTools": {
			"versions": [ "1.1.1", "1.1.2", "1.2.1", "1.2.2", "1.2.3", "1.2.4", "1.2.5", "1.3.0" ],
			"url": "mootools/XYZ/mootools-yui-compressed.js"
		},
		"Prototype": {
			"versions": [ "1.6.0.2", "1.6.0.3", "1.6.1.0", "1.7.0.0" ],
			"url": "prototype/XYZ/prototype.js"
		},
		"scriptaculous": {
			"versions": [ "1.8.1", "1.8.2", "1.8.3" ],
			"url": "scriptaculous/XYZ/scriptaculous.js"
		},
		"SWFObject": {
			"versions": [ "2.1", "2.2" ],
			"url": "swfobject/XYZ/swfobject.js"
		},
		"YUI": {
			"versions": [ "2.6.0", "2.7.0", "2.8.0r4", "2.8.1", "2.8.2", "3.3.0" ],
			"url": "yui/XYZ/build/yui/yui-min.js"
		}
	};

if ( request.method === "POST" ) {
	request.body.done(function( query ) {
		query = require("querystring").parse( query );
		var includes = [], name, ver, url;
		for( var name in query ) {
			ver = query[ name ];
			url = libraries[ name ].url;
			if ( name === "YUI" && /^2/.test( ver ) ) {
				url = url.replace( /\/yui/g, "/yuiloader" );
			}
			includes[ name === "prototype" ? "unshift" : "push" ]( "<script src=\"" + baseURL + url.replace( "XYZ", ver ) + "\"></script>" ); 
		}
		includes = includes.join( "\n" );
		require("fs").readFile( require("path").join( __dirname, "index.html" ), function( err, data ) {
			if ( err ) {
				throw err;
			}
			response.end( ( "" + data ).replace( "<!-- Includes -->", includes ) );
		});		
	});
} else {
?>
<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<title>Run jQuery Test Suite Polluted</title>
	<style type="text/css">
		.otherlibs fieldset {
			width: 400px
		}
		.otherlibs label{
			margin: 5px 0px 5px 20px;
		}
	</style>
</head>

<body id="body">
	<h1 id="header">jQuery Test Suite</h1>
	<h2 id="banner" class="fail"></h2>
	<h2 id="userAgent">Choose other libraries to include</h2>

	<form class="otherlibs" action="./polluted.jhp" method="POST">
		<?
			for( var name in libraries ) {
				response.write( "<fieldset><legend>" + name + "</legend>" );
				libraries[ name ].versions.forEach(function( ver, i ) {
					response.write( "<label><input type='radio' name='" + name + "' value='" + ver + "' />" + ver + "</label>" );
					if( ( i % 4 ) === 3 ) {
						response.write("<br />");
					}
				});
				response.write("</fieldset>");
			}
		?>
		<input type="submit" value=" Run " class="submit" />
	</form>
</body>
</html>
<?
	response.end();
}